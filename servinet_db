-- SERVINET - MODELO DE BASE DE DATOS (MySQL/MariaDB)
-- VersiÃ³n: FINAL CORREGIDA CON FOTOS Y PORTAFOLIO
-- Autor: Gemini AI

-- ======================================================
-- 0. DESACTIVAR RESTRICCIONES DE SEGURIDAD (SOLUCIÃ“N ERROR #1451)
-- ======================================================
SET FOREIGN_KEY_CHECKS = 0;

-- ======================================================
-- 1. TABLAS BASE (CON MODIFICACIÃ“N DE FOTO DE PERFIL)
-- ======================================================

CREATE TABLE Cuenta (
    id_cuenta INT PRIMARY KEY AUTO_INCREMENT,
    correo VARCHAR(100) UNIQUE NOT NULL,
    contraseÃ±a VARCHAR(255) NOT NULL,
    nombre VARCHAR(100) NOT NULL,
    apellido_paterno VARCHAR(100) NOT NULL,
    apellido_materno VARCHAR(100),
    telefono VARCHAR(20) UNIQUE,
    foto_perfil_url VARCHAR(255) NULL, -- ðŸš¨ MODIFICACIÃ“N 1: URL de la foto de perfil para todos los roles ðŸš¨
    municipio VARCHAR(100) DEFAULT NULL,
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    activo BOOLEAN DEFAULT TRUE,
    INDEX idx_correo (correo),
    INDEX idx_telefono (telefono)
);

CREATE TABLE Rol (
    id_rol INT PRIMARY KEY AUTO_INCREMENT,
    nombre_rol VARCHAR(50) UNIQUE NOT NULL,
    descripcion TEXT,
    INDEX idx_nombre_rol (nombre_rol)
);

CREATE TABLE MunicipioPuebla (
    id_municipio INT PRIMARY KEY AUTO_INCREMENT,
    nombre_municipio VARCHAR(100) UNIQUE NOT NULL,
    estado VARCHAR(50) DEFAULT 'Puebla',
    pais VARCHAR(50) DEFAULT 'MÃ©xico',
    activo BOOLEAN DEFAULT TRUE,
    INDEX idx_nombre_municipio (nombre_municipio)
);

CREATE TABLE CategoriaServicio (
    id_categoria INT PRIMARY KEY AUTO_INCREMENT,
    nombre_categoria VARCHAR(100) NOT NULL,
    descripcion TEXT,
    icono VARCHAR(50),
    activa BOOLEAN DEFAULT TRUE,
    INDEX idx_nombre_categoria (nombre_categoria)
);

CREATE TABLE MetodoPago (
    id_metodo INT PRIMARY KEY AUTO_INCREMENT,
    nombre VARCHAR(50) UNIQUE NOT NULL,
    descripcion TEXT
);

-- ======================================================
-- 2. TABLAS SECUNDARIAS (Dependen de las tablas base)
-- ======================================================

CREATE TABLE CuentaRol (
    id_cuenta INT NOT NULL,
    id_rol INT NOT NULL,
    fecha_asignacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (id_cuenta, id_rol),
    FOREIGN KEY (id_cuenta) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    FOREIGN KEY (id_rol) REFERENCES Rol(id_rol) ON DELETE CASCADE
);

CREATE TABLE PerfilProfesional (
    id_profesional INT PRIMARY KEY AUTO_INCREMENT,
    id_cuenta INT NOT NULL UNIQUE,
    id_categoria_principal INT NULL,
    especialidades VARCHAR(200),
    experiencia TEXT, 
    tarifa DECIMAL(10,2),
    disponibilidad VARCHAR(100) DEFAULT 'Bajo Demanda', 
    descripcion TEXT,
    calificacion_promedio DECIMAL(3,2) DEFAULT 0.00,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    nombre_negocio VARCHAR(150) NULL,
    sitio_web VARCHAR(255) NULL,
    estado_verificacion ENUM('pendiente','en_revision','verificado','rechazado') DEFAULT 'pendiente',
    
    FOREIGN KEY (id_cuenta) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    FOREIGN KEY (id_categoria_principal) REFERENCES CategoriaServicio(id_categoria) ON DELETE SET NULL,
    INDEX idx_calificacion (calificacion_promedio)
);

-- ðŸš¨ MODIFICACIÃ“N 2: Nueva tabla para el Portafolio/GalerÃ­a de Trabajos ðŸš¨
CREATE TABLE PortafolioProfesional (
    id_foto INT PRIMARY KEY AUTO_INCREMENT,
    id_profesional INT NOT NULL,
    url_imagen VARCHAR(255) NOT NULL,
    descripcion VARCHAR(255) NULL,
    fecha_subida DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    FOREIGN KEY (id_profesional) REFERENCES PerfilProfesional(id_profesional) ON DELETE CASCADE
);

-- ======================================================
-- 3. TABLAS DE PROCESO
-- ======================================================

CREATE TABLE Servicio (
Â  Â  id_servicio INT PRIMARY KEY AUTO_INCREMENT,
Â  Â  id_profesional INT NOT NULL,
Â  Â  id_categoria INT NOT NULL,
Â  Â  nombre_servicio VARCHAR(150) NOT NULL,
Â  Â  descripcion TEXT,
Â  Â  precio DECIMAL(10,2) NOT NULL,
Â  Â  duracion_minutos INT DEFAULT 60,
    imagen_url VARCHAR(255) DEFAULT '/ServiNet/assets/img/default_service.webp', /* ðŸ”‘ CAMBIO CLAVE: Nueva URL de imagen */
Â  Â  disponible BOOLEAN DEFAULT TRUE,
Â  Â  fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
Â  Â  FOREIGN KEY (id_profesional) REFERENCES PerfilProfesional(id_profesional) ON DELETE CASCADE,
Â  Â  FOREIGN KEY (id_categoria) REFERENCES CategoriaServicio(id_categoria) ON DELETE CASCADE,
Â  Â  INDEX idx_categoria (id_categoria),
Â  Â  INDEX idx_disponible (disponible)
);

CREATE TABLE Cita (
    id_cita INT PRIMARY KEY AUTO_INCREMENT,
    id_cliente INT NOT NULL,
    id_servicio INT NOT NULL,
    fecha_hora DATETIME NOT NULL,
    estado ENUM('pendiente','confirmada','cancelada','finalizada') DEFAULT 'pendiente',
    comentario_cliente TEXT,
    comentario_profesional TEXT,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_cliente) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    FOREIGN KEY (id_servicio) REFERENCES Servicio(id_servicio) ON DELETE CASCADE,
    INDEX idx_fecha_hora (fecha_hora),
    INDEX idx_estado (estado)
);

CREATE TABLE Pago (
    id_pago INT PRIMARY KEY AUTO_INCREMENT,
    id_cita INT NOT NULL UNIQUE,
    monto DECIMAL(10,2) NOT NULL,
    metodo_pago VARCHAR(50), 
    fecha_pago DATETIME,
    estado_pago ENUM('pendiente','procesando','pagado','fallido','reembolsado') DEFAULT 'pendiente',
    codigo_transaccion VARCHAR(100),
    FOREIGN KEY (id_cita) REFERENCES Cita(id_cita) ON DELETE CASCADE,
    INDEX idx_estado_pago (estado_pago),
    INDEX idx_fecha_pago (fecha_pago)
);

CREATE TABLE TransaccionSegura (
    id_transaccion INT PRIMARY KEY AUTO_INCREMENT,
    id_pago INT NOT NULL,
    id_cliente INT NOT NULL,
    id_profesional INT NOT NULL,
    monto DECIMAL(10,2) NOT NULL,
    estado ENUM('retenido','liberado','en_disputa','reembolsado') DEFAULT 'retenido',
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_liberacion DATETIME,
    comentario TEXT,
    FOREIGN KEY (id_pago) REFERENCES Pago(id_pago) ON DELETE CASCADE,
    FOREIGN KEY (id_cliente) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    FOREIGN KEY (id_profesional) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    INDEX idx_estado (estado)
);

CREATE TABLE ReseÃ±a (
    id_reseÃ±a INT PRIMARY KEY AUTO_INCREMENT,
    id_cita INT NOT NULL UNIQUE,
    calificacion INT NOT NULL CHECK (calificacion >= 1 AND calificacion <= 5),
    comentario TEXT,
    fecha_reseÃ±a DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_cita) REFERENCES Cita(id_cita) ON DELETE CASCADE,
    INDEX idx_calificacion (calificacion)
);

CREATE TABLE Mensaje (
    id_mensaje INT PRIMARY KEY AUTO_INCREMENT,
    id_emisor INT NOT NULL,
    id_receptor INT NOT NULL,
    contenido TEXT NOT NULL,
    fecha_envio DATETIME DEFAULT CURRENT_TIMESTAMP,
    estado_mensaje ENUM('enviado','recibido','leido') DEFAULT 'enviado',
    FOREIGN KEY (id_emisor) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    FOREIGN KEY (id_receptor) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    INDEX idx_fecha_envio (fecha_envio)
);

CREATE TABLE Notificacion (
    id_notificacion INT PRIMARY KEY AUTO_INCREMENT,
    id_cuenta INT NOT NULL,
    tipo VARCHAR(100) NOT NULL,
    contenido TEXT NOT NULL,
    fecha_envio DATETIME DEFAULT CURRENT_TIMESTAMP,
    leido BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (id_cuenta) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    INDEX idx_leido (leido),
    INDEX idx_fecha_envio (fecha_envio)
);

CREATE TABLE Sesion (
    id_sesion INT PRIMARY KEY AUTO_INCREMENT,
    id_cuenta INT NOT NULL,
    ip_acceso VARCHAR(45),
    fecha_acceso DATETIME DEFAULT CURRENT_TIMESTAMP,
    dispositivo VARCHAR(100),
    token_sesion VARCHAR(255),
    activa BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (id_cuenta) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    INDEX idx_fecha_acceso (fecha_acceso)
);

CREATE TABLE Recuperacion (
    id_recuperacion INT PRIMARY KEY AUTO_INCREMENT,
    id_cuenta INT NOT NULL,
    token VARCHAR(255) NOT NULL,
    fecha_solicitud DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_expiracion DATETIME,
    estado_token ENUM('activo','usado','expirado') DEFAULT 'activo',
    FOREIGN KEY (id_cuenta) REFERENCES Cuenta(id_cuenta) ON DELETE CASCADE,
    INDEX idx_token (token),
    INDEX idx_estado (estado_token)
);

CREATE TABLE Disputa (
    id_disputa INT PRIMARY KEY AUTO_INCREMENT,
    id_transaccion INT NOT NULL,
    iniciada_por ENUM('cliente','profesional') NOT NULL,
    motivo TEXT NOT NULL,
    evidencia_url VARCHAR(255),
    estado ENUM('abierta','en_revision','resuelta','cancelada') DEFAULT 'abierta',
    fecha_inicio DATETIME DEFAULT CURRENT_TIMESTAMP,
    fecha_resolucion DATETIME,
    resolucion TEXT,
    FOREIGN KEY (id_transaccion) REFERENCES TransaccionSegura(id_transaccion) ON DELETE CASCADE,
    INDEX idx_estado (estado)
);

-- ======================================================
-- 4. DATOS INICIALES Y CATÃLOGOS (INSERTS)
-- ======================================================

-- Insertar roles del sistema
INSERT INTO Rol (id_rol, nombre_rol, descripcion) VALUES 
(1, 'cliente', 'Usuario que contrata servicios'),
(2, 'profesional', 'Usuario que ofrece servicios'),
(3, 'admin', 'Administrador del sistema'),
(4, 'gerente', 'Gerente con permisos limitados');

-- Insertar categorÃ­as de servicios
INSERT INTO CategoriaServicio (id_categoria, nombre_categoria, descripcion, icono) VALUES 
(1, 'Hogar', 'Servicios para el hogar y reparaciones', 'fas fa-home'),
(2, 'Automotriz', 'Servicios para vehÃ­culos', 'fas fa-car'),
(3, 'TecnologÃ­a', 'Servicios tecnolÃ³gicos y desarrollo', 'fas fa-laptop'),
(4, 'Salud', 'Servicios de salud y bienestar', 'fas fa-heartbeat'),
(5, 'FotografÃ­a', 'Servicios de fotografÃ­a y video', 'fas fa-camera'),
(6, 'EducaciÃ³n', 'Servicios educativos y tutorÃ­as', 'fas fa-graduation-cap'),
(7, 'Belleza', 'Servicios de belleza y cuidado personal', 'fas fa-spa'),
(8, 'DiseÃ±o', 'Servicios de diseÃ±o grÃ¡fico y web', 'fas fa-palette');

-- Insertar mÃ©todos de pago 
INSERT INTO MetodoPago (id_metodo, nombre, descripcion) VALUES 
(1, 'Tarjeta de CrÃ©dito', 'Pago con tarjeta de crÃ©dito'),
(2, 'Tarjeta de DÃ©bito', 'Pago con tarjeta de dÃ©bito'),
(3, 'PayPal', 'Pago a travÃ©s de PayPal'),
(4, 'Transferencia Bancaria', 'Transferencia bancaria directa');

-- Crear usuario administrador por defecto (ContraseÃ±a: Kiwi1234)
INSERT INTO Cuenta (id_cuenta, correo, contraseÃ±a, nombre, apellido_paterno, telefono, municipio) VALUES 
(1, 'admin@servinet.com', '$2y$10$fV2F0V5E5fW.S4k3.Gj9jOi0uO0I.Iq0o0.u0I0Q.u0I0Q.', 'Administrador', 'Sistema', '1234567890', 'Puebla');

-- Asignar rol de admin
INSERT INTO CuentaRol (id_cuenta, id_rol) VALUES 
(1, 3); -- admin

-- ðŸš¨ INSERCIÃ“N CORREGIDA DE LOS 217 MUNICIPIOS DE PUEBLA (SoluciÃ³n a Error #1062) ðŸš¨
INSERT INTO MunicipioPuebla (nombre_municipio) VALUES 
('Acajete'), ('Acateno'), ('AcatlÃ¡n'), ('Acatzingo'), ('Acteopan'), ('AhuacatlÃ¡n'), 
('AhuatlÃ¡n'), ('Ahuazotepec'), ('Ahuehuetitla'), ('Ajalpan'), ('Albino Zertuche'), 
('Aljojuca'), ('Altepexi'), ('AmixtlÃ¡n'), ('Amozoc'), ('Aquixtla'), ('Atempan'), 
('Atexcal'), ('Atlixco'), ('Atoyatempan'), ('Atzala'), ('AtzitzihuacÃ¡n'), 
('Atzitzintla'), ('Axutla'), ('Ayotoxco de Guerrero'), ('Calpan'), ('Caltepec'), 
('Camocuautla'), ('CaÃ±ada Morelos'), ('Caxhuacan'), ('Chalchicomula de Sesma'), 
('Chapulco'), ('Chiautla'), ('Chiautzingo'), ('Chichiquila'), ('Chietla'), 
('ChigmecatitlÃ¡n'), ('Chignahuapan'), ('Chignautla'), ('Chila'), ('Chila de la Sal'), 
('Chilchotla'), ('ChiltepÃ­n'), ('Chinantla'), ('Coatepec'), ('Coatzingo'), 
('Cohetzala'), ('CohuecÃ¡n'), ('Coronango'), ('CoxcatlÃ¡n'), ('Cuapiaxtla de Madero'), 
('Cuautempan'), ('CuautinchÃ¡n'), ('Cuautlancingo'), ('Cuayuca de Andrade'), 
('Cuetzalan del Progreso'), ('Cuyoaco'), ('Domingo Arenas'), ('EloxochitlÃ¡n'), 
('EpatlÃ¡n'), ('Esperanza'), ('Francisco Z. Mena'), ('General Felipe Ãngeles'), 
('Guadalupe'), ('Guadalupe Victoria'), ('Hermenegildo Galeana'), ('Honey'), 
('Huatlatlauca'), ('Huauchinango'), ('Huehuetla'), ('HuehuetlÃ¡n el Chico'), 
('HuehuetlÃ¡n el Grande'), ('Huejotzingo'), ('Hueyapan'), ('Hueytamalco'), 
('Hueytlalpan'), ('Huitzilan de SerdÃ¡n'), ('Ixcamilpa de Guerrero'), 
('Ixcaquixtla'), ('IxtacamaxtitlÃ¡n'), ('Ixtepec'), ('IzÃºcar de Matamoros'), 
('Jalpan'), ('Jolalpan'), ('Jonotla'), ('Jopala'), ('Juan C. Bonilla'), 
('Juan Galindo'), ('Juan N. MÃ©ndez'), ('Junto a la Cabecera'), ('La Magdalena Tlatlauquitepec'), 
('Lafragua'), ('Libres'), ('Los Reyes de JuÃ¡rez'), ('Mazapiltepec de JuÃ¡rez'), 
('Mixtla'), ('Molcaxac'), ('Naupan'), ('Nauzontla'), ('Nealtican'), 
('NicolÃ¡s Bravo'), ('Nopalucan'), ('Ocotepec'), ('Ocoyucan'), ('Olintla'), 
('Oriental'), ('PahuatlÃ¡n'), ('Palmar de Bravo'), ('Pantepec'), ('Petlalcingo'), 
('Piaxtla'), ('Puebla'), ('Quecholac'), ('QuimixtlÃ¡n'), ('Rafael Lara Grajales'), 
('San AndrÃ©s Cholula'), ('San Antonio CaÃ±ada'), ('San Diego la Mesa Tochimiltzingo'), 
('San Felipe Teotlalcingo'), ('San Felipe TepatlÃ¡n'), ('San Gabriel Chilac'), 
('San Gregorio Atzompa'), ('San JerÃ³nimo XayacatlÃ¡n'), ('San JosÃ© Chiapa'), 
('San JosÃ© MiahuatlÃ¡n'), ('San Juan Atzompa'), ('San Juan EpatlÃ¡n'), 
('San Juan Ixcaquixtla'), ('San Lorenzo Axocomanitla'), ('San MatÃ­as Tlalancaleca'), 
('San Miguel IxitlÃ¡n'), ('San Miguel Xoxtla'), ('San NicolÃ¡s Buenos Aires'), 
('San NicolÃ¡s de los Ranchos'), ('San Pablo Anicano'), ('San Pedro Cholula'), 
('San Pedro Yeloixtlahuaca'), ('San Salvador el Seco'), ('San Salvador Huixcolotla'), 
('San SebastiÃ¡n Tlacotepec'), ('Santa Catarina Tlaltempan'), ('Santa InÃ©s Ahuatempan'), 
('Santiago MiahuatlÃ¡n'), ('Santiago Zautla'), ('Soltepec'), ('Tecali de Herrera'), 
('Tecamachalco'), ('TecomatlÃ¡n'), ('Tehuitzingo'), ('Tenampulco'), ('TeopantlÃ¡n'), 
('Teotlalco'), ('Tepanco de LÃ³pez'), ('Tepetzintla'), ('Tepeyahualco'), 
('Tepeyahualco de CuauhtÃ©moc'), ('Tepexco'), ('Tepexi de RodrÃ­guez'), 
('Tepinapa'), ('Teresa de JesÃºs'), ('Tetela de Ocampo'), 
('Teteletlan'), ('TetzicatlÃ¡n'), ('TeziutlÃ¡n'), ('Tianguismanalco'), ('Tilapa'), 
('Tlachichuca'), ('Tlacotepec de Benito JuÃ¡rez'), ('Tlacuilotepec'), ('Tlahuapan'), 
('Tlanepantla'), ('Tlaola'), ('Tlaquilpa'), ('Tlatlauquitepec'), ('Tlaxco'), 
('Tochimilco'), ('Tochtepec'), ('Totoltepec de Guerrero'), ('Tulcingo'), 
('TuzamapÃ¡n de JuÃ¡rez'), ('Tzicatlacoyan'), ('Venustiano Carranza'), ('Vicente Guerrero'), 
('XayacatlÃ¡n de Bravo'), ('Xicotepec de JuÃ¡rez'), ('XicotlÃ¡n'), ('Xochiapulco'), 
('Xochiltepec'), ('XochitlÃ¡n de Vicente SuÃ¡rez'), ('XochitlÃ¡n Todos Santos'), 
('Yauhtepec'), ('Yecuatla'), ('Yehualtepec'), ('Zacapala'), ('Zacapoaxtla'), 
('Zaragoza'), ('Zautla'), ('Zihuateutla'), ('Zinacatepec'), ('Zongozotla'), 
('Zoquiapan'), ('ZoquitlÃ¡n');

-- ======================================================
-- 5. RE-ESTABLECER RESTRICCIONES
-- ======================================================
SET FOREIGN_KEY_CHECKS = 1;